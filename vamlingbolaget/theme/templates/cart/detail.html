{% extends "collection_base.html" %}
{% load fb_versions %}
{% version model.field_name version_prefix %}
{% load i18n %}
{% block pagetitle %}
	<legend><a href="javascript:history.go(-1)">Shoppinglåda</a> / {% trans "Du ändrar nu din beställning av" %}: <span id="cartitem_id" style="display: none;">{{ cartitem.id }}</span> {{ cartitem.article.name }} </legend>
{% endblock %}


{% block allcontent %}
<div class="row-fluid">{{ images.pk }}
    <div class="span5" >

        <div style="clear: both;"></div>
        <div class="span6">
            <strong>{{ cartitem.article.name }} </strong><br/>
            {% trans "Artikelnummer" %} :  <span id="sku_number">{{ cartitem.article.sku_number }}</span><br/><br/>

            {% trans "Kvalitet" %}:  {{ cartitem.article.quality }}<br/>
            {{ cartitem.article.quality.description }}
            <h4>{% trans "Pris" %}: {{ cartitem.article.price }} kr</h4>

        </div>
        <span style="padding-left: 40px;"><img src="{% version cartitem.article.file 'small' %} " >  </span>


        <div style="clear: both;"></div>


        <hr/>
    </div>


    <div class="span6">
        <div class="span7">
	    <select class="changonselect" id="color">
		{% for color in colors %}
			<option value="{{ color.order }}"
                {% if color.order == cartitem.color.order %}
                    selected="selected"
                {%endif%} >
            {% trans "Färg" %}: {{ color.name }} </option>
        {% endfor %}
	    </select> 	    

	    <select class="changonselect" id='pattern'>
		{% for pattern in patterns %}
			<option value="{{ pattern.order }}"
            {% if pattern.order == cartitem.pattern.order %}
                selected="selected"
            {%endif%}
            >
            {% trans "Mönster" %}: {{ pattern.name }}</option>
		{% endfor %}
	    </select>

		</br>
	    <select  class="changonselect"  id='size'>
		{% for size in sizes %}
			<option value="{{ size.pk }}"
                {% if size.order == 1 %}
                   selected="selected"
                {%endif%}
            > {% trans "Storlek" %}: {{ size.name }} </option>changonselect

		{% endfor %}
	    </select>
        <select  class="changonselect"  id='quantity_pk'>
            <option {%if cartitem.quantity == 1 %} selected="selected" {%endif%} value="1">{% trans "Antal" %}: 1 </option>
            <option {%if cartitem.quantity == 2 %} selected="selected" {%endif%} value="2">{% trans "Antal" %}: 2 </option>
            <option {%if cartitem.quantity == 3 %} selected="selected" {%endif%} value="3">{% trans "Antal" %}: 3 </option>
            <option {%if cartitem.quantity == 4 %} selected="selected" {%endif%} value="4">{% trans "Antal" %}: 4 </option>
        </select>

        </div>
        <span style="padding-left: 10px;"><img id="pattern_color_image" src="{{ MEDIA_URL }}/uploads/120/{{ cartitem.color.order }}f_{{ cartitem.pattern.order }}m.jpg" width="100" /></span>
        <div style="clear: both;"></div>
        <hr/>
        <div id="changetext"></div>
        <hr/>
        <div style="clear: both;"></div>
        <div class="span6">
        </div>
        <div style="display:block;">
        <span style="padding-left: 30px;">
            <button class="btn btn-success" onclick="javascript:history.go(-1)" type="button">{% trans "Avbryt" %}</button></span>
            <button id='addtocart' class="btn btn-success" type="button">{% trans "Uppdatera" %}</button></span>
        </div>
    </div>

<script>
    $(function(){
        // using jQuery
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        function sameOrigin(url) {
            // test that a given url is a same-origin URL
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                    // Send the token to same-origin, relative URLs only.
                    // Send the token only if the method warrants CSRF protection
                    // Using the CSRFToken value acquired earlier
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        })



    $(".changonselect").change(function () {

        $('#fadeifchangeorder').fadeTo(500,0.6);


        var str = "Uppdatera "+"{{ cartitem.article.name }}"+ " i ",
            folder = "{{MEDIA_URL}}uploads/120/",
            img = "";

        var once = 1;
        $(".changonselect option:selected").each(function () {
            str += $(this).text() + " ";
            if (once == 1) {
                str += " och ";
            }
            once = 2;
            pattern_id = $("#pattern").val();
            color_id = $("#color").val();
            size_id = $("#size").val();
            quantity = $("#quantity_pk").val();
            img = folder+color_id+"f_"+pattern_id+"m.jpg";
        });
        $("#changetext").text(str);
        $("#pattern_color_image").attr("src", img);
    });

    var add_or_edit = 'edit';

    $("#addtocart").click(function() {
		var sku_number = $('#sku_number').text(),
			cartitem_id = $('#cartitem_id').text(),
			pattern_id = $('#pattern option:selected').val(),
			color_id = +$('#color option:selected').val(),
			size_id = $('#size option:selected').val(),
			article_id = $('#article_pk option:selected').val(),
			quantity = $('#quantity_pk option:selected').val();

        $.ajax({
            type:"POST",
            url:"/cart/addtocart/",
            data: {
                article_sku: sku_number,
                pattern: pattern_id,
                color: color_id,
                size: size_id,
                quantity: quantity,
                cartitem_id: cartitem_id,
                add_or_edit: add_or_edit,
                csrfmiddlewaretoken: csrftoken
            },
            success: function(data){
                //var msg = data.message.msg,
                //    _ = data.cartitem;
                //$("#changetext").text( msg + _.quantity +" "+ _.article + ". Mönster: " + _.pattern + " Färg: "+ _.color+" Storlek: "+ _.size);
                window.location.replace("/cart/show/");
            }
        });


    });

    });

</script>
{% endblock %}